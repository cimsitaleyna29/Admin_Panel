import { useEffect, useMemo, useRef, useState } from "react";
import { Navigate, Route, Routes, useNavigate } from "react-router-dom";
import Login from "./components/Login";
import Navbar from "./components/Navbar";
import UserForm from "./components/UserForm";
import SalaryManager from "./components/SalaryManager";
import UserList from "./components/UserList";
import {
  clearSession,
  createUser,
  deleteUser,
  getUsers,
  loginUser,
  setUserSalary,
  updateUser
} from "./services/userService";

const TURKISH_CHAR_MAP = {
  ı: "i",
  İ: "I",
  ş: "s",
  Ş: "S",
  ğ: "g",
  Ğ: "G",
  ü: "u",
  Ü: "U",
  ö: "o",
  Ö: "O",
  ç: "c",
  Ç: "C"
};

const normalizeEmailForAuth = (value) =>
  value.replace(/[ıİşŞğĞüÜöÖçÇ]/g, (char) => TURKISH_CHAR_MAP[char] ?? char);

const emptyForm = {
  name: "",
  surname: "",
  email: "",
  phone: "",
  role: "user",
  password: ""
};

const FORM_MODES = {
  CREATE: "create",
  EDIT: "edit",
  ROLE: "role"
};

const decodeJwtPayload = (token) => {
  if (!token) {
    return null;
  }
  const segments = token.split(".");
  if (segments.length < 2) {
    return null;
  }
  const base64Url = segments[1];
  const base64 = base64Url.replace(/-/g, "+").replace(/_/g, "/");
  const padding = "=".repeat((4 - (base64.length % 4 || 4)) % 4);
  const padded = `${base64}${padding}`;
  if (typeof atob !== "function") {
    console.error("atob not available in this environment");
    return null;
  }
  try {
    const binary = atob(padded);
    const json = decodeURIComponent(
      Array.from(binary)
        .map((char) => `%${char.charCodeAt(0).toString(16).padStart(2, "0")}`)
        .join("")
    );
    return JSON.parse(json);
  } catch (err) {
    console.error("Token decode failed", err);
    return null;
  }
};

const App = () => {
  const navigate = useNavigate();
  const [currentUser, setCurrentUser] = useState(null);
  const [users, setUsers] = useState([]);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState("");
  const [success, setSuccess] = useState("");
  const [formVisible, setFormVisible] = useState(false);
  const [formData, setFormData] = useState(() => ({ ...emptyForm }));
  const [editingId, setEditingId] = useState(null);
  const [formMode, setFormMode] = useState(FORM_MODES.CREATE);
  const formRef = useRef(null);

  const isAuthenticated = useMemo(() => Boolean(currentUser), [currentUser]);
  const isAdmin = currentUser?.role === "admin";

  useEffect(() => {
    if (!isAuthenticated) {
      return;
    }
    const loadUsers = async () => {
      try {
        setLoading(true);
        setError("");
        const list = await getUsers();
        setUsers(list);
      } catch (err) {
        setError(
          err.response?.data?.detail ||
            "Kullanıcı listesi getirilirken hata oluştu."
        );
      } finally {
        setLoading(false);
      }
    };
    loadUsers();
  }, [isAuthenticated]);

  const handleLogin = async ({ email, password }) => {
    const trimmedEmail = email.trim();
    const trimmedPassword = password.trim();
    if (!trimmedEmail || !trimmedPassword) {
      setError("E-posta ve şifre zorunludur.");
      return false;
    }
    setError("");
    setSuccess("");
    setLoading(true);
    try {
      const normalizedEmail = normalizeEmailForAuth(trimmedEmail);
      const authenticated = await loginUser({
        email: normalizedEmail,
        password: trimmedPassword
      });
      const list = await getUsers();
      setUsers(list);
      const matchedUser = list.find(
        (user) => user.email.toLowerCase() === normalizedEmail.toLowerCase()
      );
      const tokenPayload = decodeJwtPayload(authenticated.accessToken);
      const roleFromToken = tokenPayload?.role ?? matchedUser?.role ?? "user";
      setCurrentUser({
        ...authenticated,
        name: matchedUser?.name || "Yönetici",
        surname: matchedUser?.surname,
        role: roleFromToken,
        email: trimmedEmail
      });
      setSuccess("");
      navigate("/users", { replace: true });
      return true;
    } catch (err) {
      const status = err.response?.status;
      if (status === 404) {
        setError("Girilen bilgi hatalı. Lütfen e-posta ve şifre bilgilerini kontrol edin.");
      } else {
        setError(
          err.response?.data?.detail ||
            "Giriş sırasında bir hata oluştu. Lütfen tekrar deneyin."
        );
      }
      return false;
    } finally {
      setLoading(false);
    }
  };

  const scrollToForm = () => {
    requestAnimationFrame(() => {
      if (formRef.current) {
        formRef.current.scrollIntoView({ behavior: "smooth", block: "start" });
      }
    });
  };

  const openForm = ({ data, mode, id }) => {
    setFormData(data);
    setEditingId(id ?? null);
    setFormMode(mode);
    setFormVisible(true);
    setSuccess("");
    setError("");
    scrollToForm();
  };

  const handleCreateUserForm = () => {
    openForm({
      data: { ...emptyForm },
      mode: FORM_MODES.CREATE
    });
  };

  const handleEditUserForm = (user) => {
    openForm({
      data: {
        name: user.name,
        surname: user.surname,
        email: user.email,
        phone: user.phone || "",
        role: user.role || "user",
        password: ""
      },
      mode: FORM_MODES.EDIT,
      id: user.id
    });
  };

  const handleRoleForm = (user) => {
    openForm({
      data: {
        name: user.name,
        surname: user.surname,
        email: user.email,
        phone: user.phone || "",
        role: user.role || "user",
        password: ""
      },
      mode: FORM_MODES.ROLE,
      id: user.id
    });
  };

  const handleFormSubmit = async (values) => {
    setLoading(true);
    setError("");
    setSuccess("");
    try {
      if (formMode === FORM_MODES.CREATE) {
        const trimmedPassword = values.password?.trim();
        if (!trimmedPassword) {
          setError("Şifre zorunludur.");
          return;
        }
        const payload = { ...values, password: trimmedPassword };
        await createUser(payload);
        setSuccess("Yeni kullanıcı oluşturuldu.");
      } else if (editingId) {
        const { password: _unusedPassword, ...payload } = values;
        await updateUser(editingId, payload);
        setSuccess(
          formMode === FORM_MODES.ROLE
            ? "Kullanıcı rolü güncellendi."
            : "Kullanıcı güncellendi."
        );
      }
      const list = await getUsers();
      setUsers(list);
      setFormVisible(false);
      setEditingId(null);
      setFormData({ ...emptyForm });
      setFormMode(FORM_MODES.CREATE);
    } catch (err) {
      setError(
        err.response?.data?.detail ||
          "Kullanıcı kaydedilirken bir hata oluştu."
      );
    } finally {
      setLoading(false);
    }
  };

  const handleDelete = async (id) => {
    const confirmation = window.confirm("Bu kullanıcı silinsin mi?");
    if (!confirmation) {
      return;
    }
    setLoading(true);
    setError("");
    setSuccess("");
    try {
      await deleteUser(id);
      const list = await getUsers();
      setUsers(list);
      setSuccess("Kullanıcı silindi.");
    } catch (err) {
      setError(
        err.response?.data?.detail ||
          "Kullanıcı silinirken bir hata oluştu."
      );
    } finally {
      setLoading(false);
    }
  };

  const saveSalaryValue = async (userId, salaryInput) => {
    if (!userId) {
      return false;
    }
    const normalizedValue = String(salaryInput ?? "").trim();
    if (!normalizedValue) {
      setError("Hata oluştu: Maaş değeri boş olamaz.");
      return false;
    }
    const numericSalary = Number(normalizedValue.replace(",", "."));
    if (Number.isNaN(numericSalary)) {
      setError("Hata oluştu: Maaş değeri sayısal olmalıdır.");
      return false;
    }
    setLoading(true);
    setError("");
    setSuccess("");
    try {
      await setUserSalary(userId, numericSalary);
      const list = await getUsers();
      setUsers(list);
      setSuccess("Maaş bilgisi güncellendi.");
      return true;
    } catch (err) {
      const detail =
        err.response?.data?.detail ||
        err.message ||
        "Maaş bilgisi güncellenirken bir hata oluştu.";
      setError(`Hata oluştu: ${detail}`);
      return false;
    } finally {
      setLoading(false);
    }
  };

  const handleSalaryManagerSave = async (userId, salaryInput) => {
    await saveSalaryValue(userId, salaryInput);
  };


  const handleLogout = () => {
    clearSession();
    setCurrentUser(null);
    setFormVisible(false);
    setEditingId(null);
    setFormData({ ...emptyForm });
    setFormMode(FORM_MODES.CREATE);
    setUsers([]);
    setSuccess("");
    setError("");
    navigate("/", { replace: true });
  };

  const handleClearLoginError = () => {
    if (error) {
      setError("");
    }
  };

  const renderFeedback = () => {
    if (!error && !success) {
      return null;
    }
    const variantClass = error ? "alert-danger" : "alert-success";
    const message = error || success;
    return (
      <div className={`alert ${variantClass} mt-3`} role="alert">
        {message}
      </div>
    );
  };

  const feedbackElement = renderFeedback();
  const isCreateMode = formMode === FORM_MODES.CREATE;
  const isRoleMode = formMode === FORM_MODES.ROLE;
  const formTitle = isCreateMode
    ? "Yeni Kullanıcı"
    : isRoleMode
    ? "Kullanıcı Rolü Güncelle"
    : "Kullanıcıyı Güncelle";
  const formSubmitLabel = isCreateMode
    ? "Kaydet"
    : isRoleMode
    ? "Rol Kaydet"
    : "Güncelle";
  const canManageRoles = isAdmin;
  const canManageSalary = isAdmin;

  return (
    <div>
      {isAuthenticated && (
        <Navbar currentUser={currentUser} onLogout={handleLogout} />
      )}
      <div className={isAuthenticated ? "dashboard-shell" : "container py-4"}>
        <Routes>
          <Route
            path="/"
            element={
              isAuthenticated ? (
                <Navigate to="/users" replace />
              ) : (
                <div>
                  <Login
                    onLogin={handleLogin}
                    loading={loading}
                    errorMessage={error}
                    successMessage={success}
                    onClearError={handleClearLoginError}
                  />
                </div>
              )
            }
          />
          <Route
            path="/users"
            element={
              isAuthenticated ? (
                <div className="dashboard-container">
                  <div className="dashboard-card">
                    <div className="dashboard-card-header">
                      <div>
                        <h2 className="dashboard-card-title">
                          Kullanıcı Listesi
                        </h2>
                        <div className="dashboard-meta">
                          <span>Toplam {users.length} kayıtlı kullanıcı</span>
                          {currentUser?.email && (
                            <span>
                              Yönetici girişi: {currentUser.name} (
                              {currentUser.email})
                            </span>
                          )}
                        </div>
                      </div>
                      <div className="dashboard-toolbar">
                        {currentUser?.name && (
                          <span className="dashboard-user">
                            {currentUser.name}
                          </span>
                        )}
                        <button
                          type="button"
                          className="dashboard-secondary"
                          disabled={!canManageSalary}
                          title={
                            canManageSalary
                              ? undefined
                              : "Sadece admin kullanıcılar maaş bilgilerini yönetebilir."
                          }
                          onClick={() => {
                            if (canManageSalary) {
                              navigate("/salaries");
                            }
                          }}
                        >
                          Maaş Bilgileri
                        </button>
                        <button
                          type="button"
                          className="dashboard-primary"
                          onClick={handleCreateUserForm}
                        >
                          Yeni Kullanıcı
                        </button>
                      </div>
                    </div>
                    {feedbackElement && (
                      <div className="dashboard-feedback">
                        {feedbackElement}
                      </div>
                    )}
                    <div className="user-table-wrapper">
                      <UserList
                        users={users}
                        loading={loading}
                        onEdit={handleEditUserForm}
                        onRole={handleRoleForm}
                        showRoleAction
                        roleActionDisabled={!canManageRoles}
                        onDelete={handleDelete}
                      />
                    </div>
                    {formVisible && (
                      <div className="dashboard-form-modal" ref={formRef}>
                        <UserForm
                          initialData={formData}
                          isEditing={!isCreateMode}
                          showRoleField={isRoleMode}
                          title={formTitle}
                          submitLabel={formSubmitLabel}
                          loading={loading}
                          onCancel={() => {
                            setFormVisible(false);
                            setFormData({ ...emptyForm });
                            setEditingId(null);
                            setFormMode(FORM_MODES.CREATE);
                          }}
                          onSubmit={handleFormSubmit}
                        />
                      </div>
                    )}
                  </div>
                </div>
              ) : (
                <Navigate to="/" replace />
              )
            }
          />
          <Route
            path="/salaries"
            element={
              !isAuthenticated ? (
                <Navigate to="/" replace />
              ) : !isAdmin ? (
                <Navigate to="/users" replace />
              ) : (
                <div className="dashboard-container">
                  <div className="dashboard-card">
                    <div className="dashboard-card-header">
                      <div>
                        <h2 className="dashboard-card-title">Maaş Yönetimi</h2>
                        <div className="dashboard-meta">
                          <span>Toplam {users.length} kayıtlı kullanıcı</span>
                          {currentUser?.email && (
                            <span>
                              Yönetici girişi: {currentUser.name} (
                              {currentUser.email})
                            </span>
                          )}
                        </div>
                      </div>
                      <div className="dashboard-toolbar">
                        <button
                          type="button"
                          className="dashboard-secondary"
                          onClick={() => navigate("/users")}
                        >
                          Kullanıcı Listesi
                        </button>
                      </div>
                    </div>
                    {feedbackElement && (
                      <div className="dashboard-feedback">
                        {feedbackElement}
                      </div>
                    )}
                    <SalaryManager
                      users={users}
                      loading={loading}
                      onSave={handleSalaryManagerSave}
                      showCloseButton={false}
                    />
                  </div>
                </div>
              )
            }
          />
          <Route path="*" element={<Navigate to="/" replace />} />
        </Routes>
      </div>
    </div>
  );
};

export default App;
